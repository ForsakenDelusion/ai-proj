## 空间编码

### 数学原理

对经度进行以下操作，获得编码向量

$$
\begin{aligned}
PE(l_{lat}, 2k) &= \sin(\frac{l_{lat}}{10000^{2k/D}}) \\
PE(l_{lat}, 2k + 1) &= \cos(\frac{l_{lat}}{10000^{2k/D}})
\end{aligned}
\quad k = 0, 1, ..., \frac{D}{2} - 1
$$

同理，对纬度也进行如下操作

$$
\begin{aligned}
PE(l_{lon}, 2k) &= \sin(\frac{l_{lon}}{10000^{2k/D}}) \\
PE(l_{lon}, 2k + 1) &= \cos(\frac{l_{lon}}{10000^{2k/D}})
\end{aligned}
\quad k = 0, 1, ..., \frac{D}{2} - 1
$$

> Q1:为什么要对位置信息进行编码操作？

> A1:为了解决非线性，非周期，破坏语义信息三个问题

- 非线性：经纬度和地理位置的对应关系并非线性表示
- 非周期：空间邻近性的断裂，比如179.9和0
- 破坏语义信息：都是首都，但是简单的经纬度并不能体现这一点（查的距离很远，但是特点可能相似，这时候需要我们用低频的角度去看）

> Q2:为什么要对奇偶不同的k进行正余弦变换

> A2:因为$PE_k(x) = \sin(\omega_k x)$是有歧义的，因为$\sin(x) = \sin(\pi - x)$所以不同位置可能编码一样，比如函数值1/2对应了30度和150度，但是分为$(\sin(\omega x), \cos(\omega x))$，则可以表示单位圆上的一个点

>Q3:这个k是什么？

>A3:表示频率的敏感度，高频的话就对一些细微的差距很敏感，可以用于识别小范围的变化（比如下个十字路口和这个十字路口的区别）。低频则是对更宏观的变化的识别（比如跨城市）

## 静态嵌入（这个地方本来就危险不危险？）

1. 输入特征: 原始静态特征$O_t \in \mathbb{R}^{N \times D}$ (N 为网格数, D 为特征维度, 如 POI、天气)、差异特征$D_t \in \mathbb{R}^{N \times D}$ (当前与历史正常的偏差);
>$$D_{t}^{l} = O_{t}^{l} - \frac{1}{n}\sum_{i=1}^{n}{O^{l}}_{(t_{i}, nor)}$$
>这里的n取5，nor表示要挑数据中的正常状态的特征，应该是按例此刻最近的五个正常的时间

2. 特征融合: 将$O_t$与$D_t$拼接, 得到“静态特征基础向量”$O_t \oplus D_t \in \mathbb{R}^{N \times 2D}$ ($\oplus$表示拼接);

>这里就是单纯的把两个向量拼在一起了

3. 加入时空编码: 将“静态特征基础向量”与“空间编码$PE$”“时间编码$ZE$”再次拼接, 得到最终静态嵌入$X_t^s \in \mathbb{R}^{N \times 2D}$ (注: 此处维度仍为 2D, 因$PE$和$ZE$的信息已通过融合融入, 实际计算中会调整维度匹配);

>这里的维度不匹配的情况就体现了融合，比如2048到1024 ——两个格子取平均塞进去，如果1024到2048，那就把一个格子平分成两份
>
>$X_t^s$是一个N行2D列的矩阵，行代表网格，D代表特征，所以每一行就是代表某个网格里面的~~静态特征~~（不全是静态，是由原始静态特征$O$，动态的差异特征$D_t$，动态的时空编码$PE+ZE$共同组成的“综合环境状态”），举个例子
>$$X_t^s = \begin{bmatrix} \text{网格1的特征向量} \\ \text{网格2的特征向量} \\ \vdots \\ \text{网格1000的特征向量} \end{bmatrix} = \begin{bmatrix} 0.12 & -0.56 & 0.03 & \dots & 0.99 \\ -1.20 & 0.45 & 0.88 & \dots & -0.01 \\ \vdots & \vdots & \vdots & \ddots & \vdots \\ 0.05 & 0.11 & -0.32 & \dots & 0.77 \end{bmatrix}_{1000 \times 128}$$

### *创新点*：在融合的时候引入深度学习模型！

## 动态演化嵌入（解决数据不平衡和动态特征过平滑的问题）

通过“Update-Decay”机制，解决数据不平衡和动态特征过平滑的问题。
目的：记住稀有异常，遗忘冗余正常，保留事件的演化规律

> 不平衡：静态数据过多
> 过平滑：信息太多，导致好不容易来个动态的特征，也无法激起什么波动

### 具体操作

1. 动态嵌入初始状态

训练开始时，所有网格的动态嵌入$X_{t=0}^d \in \mathbb{R}^{N \times 2D}$初始化为 0 向量 —— 表示“无历史事件记忆”。

空白向量会和流量等动态特征相加。

2. Update 操作（触发条件：网格 $l$ 在 $t$ 时刻有碰撞异常，标签 $y=1$）

计算逻辑：$X_{(t,l)}^d = \sigma(X_{(t,l)}^s \cdot W_1 + X_{(t-1,l)}^d \cdot W_2)$

其中：$\sigma$ 为 sigmoid 激活函数（控制输出在 $[0,1]$），$W_1 \in \mathbb{R}^{2D \times 2D}$、$W_2 \in \mathbb{R}^{2D \times 2D}$ *为可训练权重矩阵；*

>如果出事了，这个动态特征就会记住这个“创伤”
>可训练矩阵的意思是，**这个参数是会变化的，通过反向传播来改变**

3. Decay 操作（触发条件：网格 $l$ 在 $t$ 时刻无异常，标签 $y=0$）

计算逻辑：$X_{(t,l)}^d = X_{(t-1,l)}^d \cdot e^{-\phi \cdot (t-t_0)}$

>对可能出事的路口（创伤）的遗忘过程

其中：$\phi$ 为衰减常数（论文设为 2），$t_0$ 为网格 $l$ 上一次发生异常的时间；

### 问题

1. 为什么更新过程有静态特征，而衰减过程没有静态特征？

- 静态特征是“风险的基础盘”，不同网格面对相同动态变化表现形式应该是不一样的（无人的道路撞车的影响和闹市区撞车的影响不同，后者可能会导致堵车很长时间）

2. 为什么衰减的时候没有静态特征

- 遗忘冗余正常，还可以保留事件的时间演化规律
- 没有新事故，环境特征就不再起作用了，剩下的只是记忆随时间的自然衰减，环境（静态特征）只负责“制造”风险，而不负责“维持”风险（如果老师按照1的思路拷打你，既然不同网格对动态变化的反应不一样，那衰减不应该也不一样吗？回答就是：尝试加入静态特征，但是效果不如不加好，因为会导致动态特征过平滑）
- Decay的目标是遗忘，如果加上了静态特征的话，你要多久才能遗忘干净呢

3.如何处理正常数据的？（如何平衡正常和异常数据的？/如何淡化正常数据的影响？/如何解决数据类型不平衡问题？）
- 强调Decay设计，通过Update-Decay共同协调


### 空间相互影响表示学习

1. 输入：静态嵌入序列 $X_s = [X_{t-T+1}^s, ..., X_t^s] \in \mathbb{R}^{T \times N \times 2D}$ (T=5 为历史时间切片数)、动态嵌入序列 $X_d = [X_{t-T+1}^d, ..., X_t^d] \in \mathbb{R}^{T \times N \times 2D}$;
2. 注意力权重计算 (以动态嵌入$X_d$为例)：

- 定义 Query (查询)、Key (键)、Value (值)：

  - $Q_d = X_d \cdot W_{dq}$
  - $K_d = X_d^{(k+1)} \cdot W_{dk}$
  - $V_d = K_d$ (值与键来源一致，简化计算)

    > ($W_{dq} \in \mathbb{R}^{2D \times 2D}$为权重矩阵)
    > ($X_d^{(k+1)}$为邻居网格的动态嵌入，$W_{dk} \in \mathbb{R}^{2D \times 2D}$)
  
- 计算注意力权重 (Softmax 归一化)：$A_d = \text{Softmax}(\frac{Q_d \cdot K_d^T}{\sqrt{2D}}) \in \mathbb{R}^{T \times N \times 1 \times (k+1)}$ ($\sqrt{2D}$为缩放因子，避免权重过大)
- 邻居特征聚合：$X_d' = A_d \cdot V_d \in \mathbb{R}^{T \times N \times 2D}$ (将邻居特征按权重加权求和)
